{"id":"3cory51a","parent_id":"630aljx6","name":"Implement LlmExtractor service","description":"Full implementation at app/services/recipe_importers/llm_extractor.rb: RecipeSchema with RubyLLM::Schema DSL, HTML cleaning with Nokogiri, OpenRouter call with model openai/gpt-oss-20b, Result pattern, error handling","priority":1,"completed":true,"result":"Implemented LlmExtractor service with: RecipeSchema using RubyLLM::Schema DSL for structured output, HTML cleaning via Nokogiri (removes script/style/nav/header/footer/aside), text truncation to 15k chars, OpenRouter integration with model openai/gpt-oss-20b, error handling for timeouts/API errors/extraction failures, Result pattern matching existing JsonLdExtractor. Verified class loads correctly with rails runner.","metadata":null,"created_at":"2026-01-27T09:32:25.693Z","updated_at":"2026-01-27T10:17:26.365Z","completed_at":"2026-01-27T10:17:26.365Z","blockedBy":["l8ojpe4l"],"blocks":["po49gfd7"],"children":[]}
{"id":"4nsqhrf0","parent_id":"630aljx6","name":"Add POST /api/v1/recipes/import endpoint","description":"Add import action to Api::V1::RecipesController. Accepts {url: string}, validates URL, creates Recipe with source_url and import_status: pending, enqueues RecipeImportJob, returns 202 Accepted with {id, import_status}. Add route in config/routes.rb.","priority":1,"completed":false,"result":null,"metadata":null,"created_at":"2026-01-27T09:42:14.385Z","updated_at":"2026-01-27T09:42:14.385Z","completed_at":null,"blockedBy":["ofge46fi"],"blocks":["ybln4ez1"],"children":[]}
{"id":"5js43i7h","parent_id":"630aljx6","name":"Verify async import with CI and manual test","description":"Run bin/ci to ensure all tests pass. Manual test: call POST /api/v1/recipes/import with a real URL, verify 202 response, check job runs in Solid Queue, verify recipe is updated with extracted data.","priority":1,"completed":false,"result":null,"metadata":null,"created_at":"2026-01-27T09:42:37.431Z","updated_at":"2026-01-27T09:42:37.431Z","completed_at":null,"blockedBy":["ybln4ez1"],"blocks":[],"children":[]}
{"id":"630aljx6","parent_id":null,"name":"LLM Recipe Extraction Implementation Plan","description":"# LLM Recipe Extraction Implementation Plan\n\n## Goal\nImplement the `LlmExtractor` service to extract recipe data from HTML when JSON-LD structured data is not available, using the RubyLLM gem with OpenRouter as the inference provider.\n\n## Implementation Steps\n\n### 1. Add ruby-llm gem to Gemfile\n**File**: `Gemfile`\n\nAdd the gem:\n```ruby\ngem \"ruby_llm\"\n```\n\nThen run `bundle install`.\n\n### 2. Configure RubyLLM with OpenRouter credentials\n**File**: `config/initializers/ruby_llm.rb` (new file)\n\n```ruby\nRubyLLM.configure do |config|\n  config.openrouter_api_key = Rails.application.credentials.dig(:openrouter, :api_key)\nend\n```\n\n**Credentials setup** (user must add via `bin/rails credentials:edit`):\n```yaml\nopenrouter:\n  api_key: sk-or-v1-...\n```\n\n### 3. Implement LlmExtractor service\n**File**: `app/services/recipe_importers/llm_extractor.rb`\n\nKey implementation details:\n\n1. **Define a RecipeSchema** using RubyLLM::Schema DSL:\n   ```ruby\n   class RecipeSchema < RubyLLM::Schema\n     string :name, description: \"Recipe title\"\n     array :ingredients, of: :string, description: \"List of ingredients with quantities\"\n     array :instructions, of: :string, description: \"Step-by-step cooking instructions\"\n     integer :prep_time, required: false, description: \"Preparation time in minutes\"\n     integer :cook_time, required: false, description: \"Cooking time in minutes\"\n     integer :servings, required: false, description: \"Number of servings\"\n     string :notes, required: false, description: \"Recipe description or notes\"\n   end\n   ```\n\n2. **Clean HTML** before sending to LLM:\n   - Strip `<script>`, `<style>`, `<nav>`, `<header>`, `<footer>`, `<aside>` tags\n   - Extract meaningful text content using Nokogiri\n   - Limit text length to avoid token limits (~15,000 chars)\n\n3. **Send to OpenRouter** with structured output:\n   ```ruby\n   chat = RubyLLM.chat(model: 'openai/gpt-oss-20b', provider: :openrouter)\n   response = chat.with_schema(RecipeSchema).ask(prompt)\n   ```\n\n4. **Return Result** matching existing pattern:\n   ```ruby\n   Result.new(\n     success?: true,\n     recipe_attributes: {\n       name: response.content['name'],\n       ingredients: response.content['ingredients'],\n       instructions: response.content['instructions'],\n       prep_time: response.content['prep_time'],\n       cook_time: response.content['cook_time'],\n       servings: response.content['servings'],\n       notes: response.content['notes'],\n       source_url: @source_url\n     },\n     error: nil,\n     error_code: nil\n   )\n   ```\n\n5. **Error handling**:\n   - Wrap LLM call in begin/rescue\n   - Handle network errors, API errors, timeout\n   - Return failure Result with appropriate error codes (`:llm_error`, `:llm_timeout`, `:extraction_failed`)\n\n### 4. The Extraction Prompt\n\n```\nExtract recipe information from the following webpage content.\nFind the recipe name, ingredients list, and cooking instructions.\n\nIf you cannot find recipe content, return an empty name field.\n\nWebpage content:\n---\n{cleaned_html_text}\n---\n```\n\n### 5. Write tests\n**File**: `test/services/recipe_importers/llm_extractor_test.rb`\n\nTest scenarios:\n- Successful extraction with mocked LLM response\n- Handles LLM API errors gracefully\n- Handles missing/partial recipe data\n- Text cleaning removes irrelevant HTML elements\n- Respects text length limits\n\nUse WebMock to stub OpenRouter API calls.\n\n## Model Choice\n\nUsing `openai/gpt-oss-20b` via OpenRouter as specified. This model will be used with RubyLLM's structured output feature via the `with_schema()` method.\n\n## Files to Modify/Create\n\n| File | Action |\n|------|--------|\n| `Gemfile` | Add `gem \"ruby_llm\"` |\n| `config/initializers/ruby_llm.rb` | Create - RubyLLM configuration |\n| `app/services/recipe_importers/llm_extractor.rb` | Modify - Full implementation |\n| `test/services/recipe_importers/llm_extractor_test.rb` | Create - Unit tests |\n\n## Verification\n\n1. Run `bundle install` to install ruby-llm\n2. Add OpenRouter API key to credentials\n3. Run test suite: `bin/rails test test/services/recipe_importers/`\n4. Manual test: Import a recipe URL that lacks JSON-LD data (e.g., a simple blog post with a recipe)\n5. Run full CI: `bin/ci`\n","priority":1,"completed":false,"result":null,"metadata":null,"created_at":"2026-01-27T09:31:12.678Z","updated_at":"2026-01-27T09:31:12.678Z","completed_at":null,"blockedBy":[],"blocks":[],"children":["e8ft52is","l8ojpe4l","3cory51a","po49gfd7","ze6674t4","cskpamrk","ofge46fi","4nsqhrf0","ybln4ez1","5js43i7h"]}
{"id":"cskpamrk","parent_id":"630aljx6","name":"Add import_status column to recipes table","description":"Create migration to add import_status enum column to recipes table. Values: pending, completed, failed. Default: completed (for existing recipes). This enables tracking async import progress.","priority":1,"completed":true,"result":"Added import_status enum column (pending: 0, completed: 1, failed: 2) with default: completed. Migration and enum declaration in Recipe model verified. All 205 tests pass.","metadata":null,"created_at":"2026-01-27T09:41:53.449Z","updated_at":"2026-01-27T10:55:41.472Z","completed_at":"2026-01-27T10:55:41.472Z","blockedBy":["ze6674t4"],"blocks":["ofge46fi"],"children":[]}
{"id":"e8ft52is","parent_id":"630aljx6","name":"Add ruby-llm gem to Gemfile","description":"Add gem 'ruby_llm' to Gemfile and run bundle install","priority":1,"completed":true,"result":"Added gem 'ruby_llm' to Gemfile (line 28) and ran bundle install. Installed ruby_llm 1.11.0 along with dependencies: event_stream_parser 1.0.0, ruby_llm-schema 0.2.5, faraday-retry 2.4.0, faraday-multipart 1.2.0. Verified with 'bundle info ruby_llm'.","metadata":null,"created_at":"2026-01-27T09:32:17.744Z","updated_at":"2026-01-27T09:46:49.251Z","completed_at":"2026-01-27T09:46:49.251Z","blockedBy":[],"blocks":["l8ojpe4l"],"children":[]}
{"id":"l8ojpe4l","parent_id":"630aljx6","name":"Configure RubyLLM with OpenRouter credentials","description":"Create config/initializers/ruby_llm.rb with OpenRouter API key configuration using Rails.application.credentials.dig(:openrouter, :api_key)","priority":1,"completed":true,"result":"Created config/initializers/ruby_llm.rb that configures RubyLLM with OpenRouter API key from Rails encrypted credentials. Verified initializer loads correctly with 'bin/rails runner'. User must add their API key via 'bin/rails credentials:edit' under openrouter.api_key path.","metadata":null,"created_at":"2026-01-27T09:32:21.162Z","updated_at":"2026-01-27T09:57:33.328Z","completed_at":"2026-01-27T09:57:33.328Z","blockedBy":["e8ft52is"],"blocks":["3cory51a"],"children":[]}
{"id":"ofge46fi","parent_id":"630aljx6","name":"Create RecipeImportJob background job","description":"Create app/jobs/recipe_import_job.rb using Solid Queue. Job receives recipe_id and source_url, calls RecipeImporter, updates recipe with extracted data and sets import_status to completed or failed. Handle errors gracefully.","priority":1,"completed":false,"result":null,"metadata":null,"created_at":"2026-01-27T09:42:03.405Z","updated_at":"2026-01-27T09:42:03.405Z","completed_at":null,"blockedBy":["cskpamrk"],"blocks":["4nsqhrf0"],"children":[]}
{"id":"po49gfd7","parent_id":"630aljx6","name":"Write tests for LlmExtractor","description":"Create test/services/recipe_importers/llm_extractor_test.rb with scenarios: successful extraction, API errors, partial data, HTML cleaning, text length limits. Use WebMock for API stubbing","priority":1,"completed":true,"result":"Created test/services/recipe_importers/llm_extractor_test.rb with 20 tests covering: successful extraction, API errors (timeout, connection failure, API errors), HTML cleaning (script/style/nav removal, whitespace normalization), text length limits, and partial data handling. Also created shared LlmStubHelper in test/test_helpers/ to DRY up LLM stubbing across test files. All 205 tests pass.","metadata":null,"created_at":"2026-01-27T09:32:29.446Z","updated_at":"2026-01-27T10:40:57.837Z","completed_at":"2026-01-27T10:40:57.837Z","blockedBy":["3cory51a"],"blocks":["ze6674t4"],"children":[]}
{"id":"ybln4ez1","parent_id":"630aljx6","name":"Write tests for async recipe import","description":"Test coverage for: RecipeImportJob (success, failure, error handling), Api::V1::RecipesController#import (returns 202, creates pending recipe, enqueues job, validates URL). Use perform_enqueued_jobs for integration tests.","priority":1,"completed":false,"result":null,"metadata":null,"created_at":"2026-01-27T09:42:26.684Z","updated_at":"2026-01-27T09:42:26.684Z","completed_at":null,"blockedBy":["4nsqhrf0"],"blocks":["5js43i7h"],"children":[]}
{"id":"ze6674t4","parent_id":"630aljx6","name":"Verify implementation with CI and manual test","description":"Run bundle install, ensure API key in credentials, run test suite, manual test with URL lacking JSON-LD, run bin/ci","priority":1,"completed":true,"result":"CI suite passes. All tests pass. LlmExtractor implementation verified.","metadata":null,"created_at":"2026-01-27T09:32:33.493Z","updated_at":"2026-01-27T10:52:26.067Z","completed_at":"2026-01-27T10:52:26.067Z","blockedBy":["po49gfd7"],"blocks":["cskpamrk"],"children":[]}
